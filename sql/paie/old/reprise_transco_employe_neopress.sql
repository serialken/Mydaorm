drop table emp_transco;
create table emp_transco(mat_org varchar(10),mat_dst varchar(10));
insert into emp_transco values('MEM7833220','Z004024400');
insert into emp_transco values('MET0207220','Z004743300');
insert into emp_transco values('MET0077820','Z004744100');
insert into emp_transco values('MET0041220','Z004444300');
insert into emp_transco values('MEM5750320','Z004936100');
insert into emp_transco values('MEM6352320','Z004082500');
insert into emp_transco values('MET0072920','Z004975800');
insert into emp_transco values('MEK7556620','Z004258100');
insert into emp_transco values('MET0214120','Z004067700');
insert into emp_transco values('MEM7329820','Z004475200');
insert into emp_transco values('MEB8413820','Z004785600');
insert into emp_transco values('MET0146120','7000263000');
insert into emp_transco values('MET0064720','Z004971900');
insert into emp_transco values('MET0107320','Z004415000');
insert into emp_transco values('MET0135320','7000186700');
insert into emp_transco values('MET0088920','7000012300');
insert into emp_transco values('MET0084420','Z004816200');
insert into emp_transco values('MEK9489320','Z004258400');
insert into emp_transco values('MET0175320','Z004905500');
insert into emp_transco values('MET0056420','Z004538000');
insert into emp_transco values('MEM7872220','Z004043000');
insert into emp_transco values('MET0200820','MET0220520');
insert into emp_transco values('MEM8230120','Z004205000');
insert into emp_transco values('MEN0714020','Z004246200');
insert into emp_transco values('MET0218320','Z004897500');
insert into emp_transco values('MEM7982820','Z004833300');
insert into emp_transco values('MEK3467020','Z004891600');
insert into emp_transco values('MEM7802820','Z004726400');
insert into emp_transco values('MEM9630220','7000095000');
insert into emp_transco values('MEK9491620','Z004662500');
insert into emp_transco values('MET0099820','7000068000');
insert into emp_transco values('MET0144820','7000212600');
insert into emp_transco values('MET0042020','Z004419900');
insert into emp_transco values('MEM8361320','Z004684800');
insert into emp_transco values('MEM6212120','Z004490800');
insert into emp_transco values('MEM6555720','Z004080100');
insert into emp_transco values('MEM9967220','Z004324700');
insert into emp_transco values('MET0094220','7000341700');
insert into emp_transco values('MEB0321720','7000115400');
insert into emp_transco values('MET0074220','7000058600');
insert into emp_transco values('MET0208420','MET0220320');
insert into emp_transco values('MET0098020','7000125800');
insert into emp_transco values('MET0213720','7000288300');
insert into emp_transco values('MEM5950520','7000022600');
insert into emp_transco values('MEM7536120','7000266200');
insert into emp_transco values('MEM8233720','Z004795200');
insert into emp_transco values('MET0154720','7000101700');
insert into emp_transco values('MEK3472520','7000165300');
insert into emp_transco values('MET0028620','Z004081000');
insert into emp_transco values('MEM8780820','7000140100');
insert into emp_transco values('MET0096420','Z005021100');
insert into emp_transco values('MET0218920','7000213000');
insert into emp_transco values('MET0199620','MET0220920');
insert into emp_transco values('MEM8080120','7000060200');
insert into emp_transco values('MEM9611520','Z004519500');
insert into emp_transco values('MEN0517220','Z004916200');
insert into emp_transco values('MET0213620','7000134200');
insert into emp_transco values('MET0188920','7000283400');
insert into emp_transco values('MET0218520','7000294600');
insert into emp_transco values('MEK9487420','Z004117200');
insert into emp_transco values('MEM5986720','Z004017000');
insert into emp_transco values('MEM8135720','Z004197600');
insert into emp_transco values('MET0187620','7000234100');
insert into emp_transco values('MET0121020','7000266700');
insert into emp_transco values('MET0127020','Z005009000');
insert into emp_transco values('MET0223020','7000298500');
insert into emp_transco values('MET0222620','7000320500');
insert into emp_transco values('MET0222420','7000304800');
insert into emp_transco values('MET0221320','7000142700');
insert into emp_transco values('MET0139220','Z004919000');
insert into emp_transco values('MET0172520','Z004964500');
insert into emp_transco values('MET0088120','7000039000');
insert into emp_transco values('MET0137420','7000039800');
insert into emp_transco values('MET0092120','7000081000');
insert into emp_transco values('MET0083120','7000024500');
insert into emp_transco values('MEM7869820','Z004745000');
insert into emp_transco values('MEM9784620','7000182300');
insert into emp_transco values('MEM7802120','Z004047900');
insert into emp_transco values('MEM8661720','Z004787900');
insert into emp_transco values('MET0195320','7000250100');
insert into emp_transco values('MET0063320','Z005061200');
insert into emp_transco values('MET0092220','7000128200');
insert into emp_transco values('MET0060920','7000200900');
insert into emp_transco values('MET0093620','Z004041300');
insert into emp_transco values('MET0130620','7000199700');
insert into emp_transco values('MET0133620','7000136700');
insert into emp_transco values('NEP0133700','7000078300');
insert into emp_transco values('MET0126820','7000135200');
insert into emp_transco values('MET0136920','Z004695200');
insert into emp_transco values('MEM7918320','Z004929200');
insert into emp_transco values('MET0202620','Z005028300');
insert into emp_transco values('MET0222120','Z004772000');
insert into emp_transco values('NEP0140800','NEP0145600');
insert into emp_transco values('MET0204320','MET0208900');
insert into emp_transco values('NEP0139600','NEP0142200');
insert into emp_transco values('MET0206620','MET0220400');
insert into emp_transco values('MET0207420','MET0218200');
insert into emp_transco values('MET0207020','MET0215200');
insert into emp_transco values('NEO0145800','Z005045900');
insert into emp_transco values('MEN0189120','Z004418100');
insert into emp_transco values('MET0206820','7000304800');
insert into emp_transco values('MET0222820','MET0217720');
insert into emp_transco values('MET0223320','MET0219820');
insert into emp_transco values('NEP0140800','NEP0145600');
insert into emp_transco values('MET0204320','MET0208920');
insert into emp_transco values('NEP0139620','NEP0142220');
insert into emp_transco values('MET0206620','MET0220420');
insert into emp_transco values('MET0207420','MET0218220');
insert into emp_transco values('MET0207020','MET0215220');
insert into emp_transco values('MET0224220','MET0215920');




select * from emp_transco where length(mat_org)<>10 or length(mat_dst)<>10;
alter table emp_transco add emp_org int(11),add emp_dst int(11);
/*
insert into emp_transco(mat_org,mat_dst,emp_org,emp_dst) 
select e2.matricule,e1.matricule,e2.id,e1.id
from employe e1
inner join employe e2 on e1.nom=e2.nom and e1.prenom1=e2.prenom1 and e1.prenom2=e2.prenom2
and e1.matricule like 'Z%' and (e2.matricule like 'M%' or e2.matricule like 'N%')
and ((e1.matricule like '%00' and e2.matricule like '%00')
or (e1.matricule like '%20' and e2.matricule like '%20'))
order by e1.nom;

insert into emp_transco(mat_org,mat_dst,emp_org,emp_dst) 
select e2.matricule,e1.matricule,e2.id,e1.id
from employe e1
inner join employe e2 on e1.nom=e2.nom and e1.prenom1=e2.prenom1 and e1.prenom2=e2.prenom2 and e1.matricule<>e2.matricule and e1.matricule=e1.saloid
order by e1.nom;
*/
update emp_transco t inner join employe e on t.mat_org=e.matricule set t.emp_org=e.id;
update emp_transco t inner join employe e on t.mat_dst=e.matricule set t.emp_dst=e.id;
update emp_transco t inner join employe e on substr(t.mat_org,1,8)=substr(e.matricule,1,8) set t.emp_org=e.id;
update emp_transco t inner join employe e on substr(t.mat_dst,1,8)=substr(e.matricule,1,8) set t.emp_dst=e.id;

select * from emp_transco where emp_org=emp_dst;
select * from emp_transco where emp_org is null or emp_dst is null;
select * from emp_transco where emp_org is not null;
select * from emp_transco t
inner join employe e1 on t.emp_org=e1.id
left outer join emp_pop_depot epd1 on e1.id=epd1.employe_id
left outer join employe e2 on t.emp_dst=e2.id
left outer join emp_pop_depot epd2 on e2.id=epd2.employe_id
where emp_org is not null;

update modele_tournee o inner join emp_transco t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where t.emp_dst is not null;
update modele_tournee_jour o inner join emp_transco t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where t.emp_dst is not null;
update modele_activite o inner join emp_transco t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where t.emp_dst is not null;
update pai_tournee o inner join emp_transco t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where t.emp_dst is not null;
update pai_activite o inner join emp_transco t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where t.emp_dst is not null;
update pai_ev_activite o inner join emp_transco t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where t.emp_dst is not null;
update pai_ev_tournee o inner join emp_transco t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where t.emp_dst is not null;
delete from pai_journal where employe_id in (select emp_org from emp_transco);
delete from modele_journal where employe_id in (select emp_org from emp_transco);
delete from emp_cycle where employe_id in (select emp_org from emp_transco);
delete from emp_pop_depot where employe_id in (select emp_org from emp_transco);
delete from employe where id in (select emp_org from emp_transco);
truncate table pai_ev_activite;
select * from emp_pop_depot where employe_id in (select emp_dst from emp_transco);

select * from employe where matricule like 'Z0050283%';
select * from employe where matricule like 'Z0047879%';
select * from employe where matricule like 'NEP01422%';

-- --------------------------------------------
-- contrôle
select * from  modele_tournee mt inner join employe e on mt.employe_id=e.id inner join groupe_tournee gt on mt.groupe_id=gt.id where (gt.flux_id=1 and e.matricule like '%20' or  gt.flux_id=2 and e.matricule like '%00');
select distinct mtj.employe_id,e.matricule,gt.depot_id,gt.flux_id from  modele_tournee_jour mtj inner join employe e on mtj.employe_id=e.id inner join modele_tournee mt on mtj.tournee_id=mt.id inner join groupe_tournee gt on mt.groupe_id=gt.id where (gt.flux_id=1 and e.matricule like '%20' or  gt.flux_id=2 and e.matricule like '%00');
select * from  modele_activite ma inner join employe e on ma.employe_id=e.id where (ma.flux_id=1 and e.matricule like '%20' or  ma.flux_id=2 and e.matricule like '%00');
select * from  pai_activite ma inner join employe e on ma.employe_id=e.id where (ma.flux_id=1 and e.matricule like '%20' or  ma.flux_id=2 and e.matricule like '%00');
select distinct e.id,e.matricule,ma.depot_id,ma.flux_id from  pai_tournee ma inner join employe e on ma.employe_id=e.id where (ma.flux_id=1 and e.matricule like '%20' or  ma.flux_id=2 and e.matricule like '%00');

-- --------------------------------------------
/*
drop table emp_transco2;
create table emp_transco2 as 
select distinct e.matricule as mat_org,concat(substr(e.matricule,1,8),'00') as mat_dst from  modele_tournee_jour mtj inner join employe e on mtj.employe_id=e.id inner join modele_tournee mt on mtj.tournee_id=mt.id inner join groupe_tournee gt on mt.groupe_id=gt.id where (gt.flux_id=1 and e.matricule like '%20' or  gt.flux_id=2 and e.matricule like '%00')
union
select distinct e.matricule,concat(substr(e.matricule,1,8),'00') from  pai_tournee ma inner join employe e on ma.employe_id=e.id where (ma.flux_id=1 and e.matricule like '%20' or  ma.flux_id=2 and e.matricule like '%00');

alter table emp_transco2 add emp_org int(11),add emp_dst int(11);
update emp_transco2 t inner join employe e on t.mat_org=e.matricule set t.emp_org=e.id;
update emp_transco2 t inner join employe e on t.mat_dst=e.matricule set t.emp_dst=e.id;

select * from emp_transco2 where emp_org=emp_dst;
select * from emp_transco2 where emp_org is null or emp_dst is null;
delete from emp_transco2 where emp_org is null or emp_dst is null;

begin work;
update modele_tournee o inner join groupe_tournee g on o.groupe_id=g.id inner join emp_transco2 t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where g.flux_id=1;
update modele_tournee_jour o inner join modele_tournee mt on o.tournee_id=mt.id inner join groupe_tournee g on mt.groupe_id=g.id inner join emp_transco2 t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where g.flux_id=1;
update modele_activite o inner join emp_transco2 t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where o.flux_id=1;
update pai_tournee o inner join emp_transco2 t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where o.flux_id=1;
update pai_activite o inner join emp_transco2 t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where o.flux_id=1;
update pai_ev_activite o inner join emp_transco2 t on o.employe_id=t.emp_org set o.employe_id=t.emp_dst where o.flux_id=1;
delete from pai_journal where employe_id in (select emp_org from emp_transco2) and flux_id=1;
delete from modele_journal where employe_id in (select emp_org from emp_transco2) and flux_id=1;
commit;
*/