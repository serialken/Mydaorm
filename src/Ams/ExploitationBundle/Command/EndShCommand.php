<?php
namespace Ams\ExploitationBundle\Command;

use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\OutputInterface;
use Ams\SilogBundle\Lib\StringLocal;
use Ams\SilogBundle\Command\GlobalCommand;


/**
 * "Command" Termine le tracking d'un CRON
 *
 * @author ydieng
 */
class EndShCommand extends GlobalCommand
{
    protected $suiviCron;
    
    protected function configure()
    {
        $this->sNomCommande = 'end_sh';
        $this->setName($this->sNomCommande);
        $this->setDescription('Termine le lancement d\'un CRON')
                ->addArgument('id', InputArgument::REQUIRED, 'ID AI du cron');
    }
    
    protected function execute(InputInterface $input, OutputInterface $output){
        parent::execute($input, $output); // Obligatoire pour tout "command". Afin d'initialiser les fichiers de logs
        
         //Récupération du libelle du CRON
        $id = $input->getArgument('id');
        
        $this->oLog->info(date("d/m/Y H:i:s : ") . "Debut Finalisation du CRON  - Commande : " . $this->sNomCommande);
        
        //Recuperation des différents  repository
        $suiviCronRepo = $this->getContainer()->get('doctrine')->getRepository('AmsExploitationBundle:SuiviCron');
        $suiviCommandRepo = $this->getContainer()->get('doctrine')->getRepository('AmsExploitationBundle:SuiviCommand');
        $this->suiviCron = $suiviCronRepo->findOneById($id);
        
        $this->suiviCommand->setHeureFin(new \DateTime(date("Y-m-d H:i:s")));
        $this->endTraitement();
        
        $this->suiviCron->setHeureFin(new \DateTime(date("Y-m-d H:i:s")));
        
        $em = $this->getContainer()->get('doctrine')->getManager();
        $em->persist($this->suiviCron);
        $em->flush();
        $this->oLog->info(date("d/m/Y H:i:s : ") . "Fin Finalisation du CRON  - Commande : " . $this->sNomCommande);
        return ;
    }
}
