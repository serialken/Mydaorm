{% extends '::dhtmlx_grid.html.twig' %}
{% block title %}Suivi des activités{% endblock %}
{% block body %}
    <style>
        #formSuiviCron td {
            padding: 3px;
        }
        #formSuiviCron td{position:relative;}
        #formSuiviCron label{text-align:center;float:left;}
{#        #formSuiviCron label{text-align:right;float:left;width:100%}#}
{#        #formSuiviCron input[type=text],#formSuiviCron select,.select2-container{width:90%;float:left}#}
{#        .error_form { color:red;}#}
        table td{
            text-align: center;
        }
    </style>
    <div class="well" >
        <form method="post" name="formSuiviCron" id="formSuiviCron" action="{{path('suivi_cron_vue_generale')}}" >
            <table>
                <tr>
                    <td>
                       {{ form_label(form.DateCron) }}:
                    </td>
                    <td>
                        {{ form_widget(form.DateCron, {'attr': {'value': dateCron}, 'id': 'dateCron', 'name': 'dateCron'}) }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td>
                        {{ form_label(form.Heure) }}:
                    </td>
                    <td>
                        {{ form_widget(form.Heure, {'value': heure } ) }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td>
                        {{ form_label(form.Cron) }}:
                    </td>
                    <td>
                        {{ form_widget(form.Cron, {'value': cron } ) }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </td>
                    <td>
                        {{ form_label(form.Etat) }}:
                    </td>
                    <td>
                        {{ form_widget(form.Etat, {'value': etat }) }}
                    </td>
                </tr>
                <tr>
                    <td colspan="8">
                        <button type="submit" class="btn-small btn-primary" onmouseover="affPopoverLien(this);" data-description="Rechercher des CRON" data-content="Ce bouton permet de rechercher des cron via les informations suivantes: la date, l'heure, le nom du cron et son etat.Il affiche une liste qui recense ces précédents critéres.">
                            <i class="glyphicon glyphicon-search white"></i>	Rechercher
                        </button>
                    </td>
                </tr>
            </table>
        </form>
        {# affichage du nombre de lignes du tableau #}
        <div id="infoSuiviCron" class="alert alert-info" role="alert">...</div>
        <button type="button" class="btn-small btn-primary" onclick="reloadGrid(this);" onmouseover="affPopoverLien(this);" data-content="Ce lien permet de mettre à jour les données présentes dans le tableau.">
            <i class="glyphicon glyphicon-refresh"></i>  Rafraîchir
        </button>
    </div>
    {# Affichage du bloc des msg  #}
    <div id="listeSuiviCronNotifications">
        <div class="alert alert-success alert-dismissible" role="alert">
            <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            Vos modifications ont été enregistrées avec succés.
        </div>
    </div>
    {# Affichage de la grid #}
    <div  style='position:relative; height:700px; width:100%;'>
        <table width="100%" cellpadding="0" cellspacing="0">
            <tr>
                <td>
                    <div id="gridbox"  style="width:100%; height:500px; background-color:white;overflow:hidden"></div>
                    <div id="cover" style='width:500px; font-size:20pt; text-align:center; font-family:Tahoma; position:absolute; top:50px; left:100px; height:150px; widht:500px; background-color:silver; opacity:0.3; -moz-opacity:0.3; filter:alpha(opacity=30);'>
                        Chargement ...
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div id="recinfoArea"></div>
                </td>
            </tr>
        </table>
    </div>    
    <script src="{{asset('js/jquery.toaster.js')}}"></script>
    <script>
        $(document).ready(function() {
            $.datepicker.setDefaults($.datepicker.regional[ "fr" ]);
            $("form input#dateCron").datepicker({
                dateFormat: 'dd/mm/yy',
            }).attr("readonly", "readonly");
            // On masque les alertes par défaut
            $('#listeSuiviCronNotifications .alert').hide();
        });
        
        /** Initialisation **/
        MyGrid = new dhtmlXGridObject('gridbox');
        MyGrid.setImagePath("{{dhtmlx_img }}");

        MyGrid.setHeader("Batch, Commande, Heure Début, Heure Fin, Etat, Message, ERREUR, Fichiers de log");
        MyGrid.attachHeader("#select_filter,#select_filter,,,#select_filter,#select_filter,#select_filter,");
        MyGrid.enableAutoWidth(true);
        MyGrid.setColAlign("center,center,center,center,center,center,center,center");
        MyGrid.init();
        
        /** Evenement de chargement de la page **/
        MyGrid.attachEvent("onXLS", function() {
            document.getElementById('cover').style.display = 'block';
            $('#infoSuiviCron').html('Veuillez patientez pendant le chargement du tableau ...');
        });
        MyGrid.attachEvent("onXLE", function() {
            document.getElementById('cover').style.display = 'none';
            var res = "Résultat de la recherche: <strong>" + MyGrid.getRowsNum() + " </strong> ligne(s)";
            $('#infoSuiviCron').html(res);
        });
        MyGrid.attachEvent("onFilterEnd", function() {
            var res = "Résultat de la recherche: <strong>" + MyGrid.getRowsNum() + " </strong> ligne(s)";
            $('#infoSuiviCron').html(res);
        });
        
        MyGrid.setSkin("dhx_skyblue");
        MyGrid.enableSmartRendering(false);

        /** Pagination */
        MyGrid.enablePaging(true, 30, 3, "recinfoArea");
        MyGrid.setPagingSkin("toolbar", "dhx_skyblue");

        /** descativation de la generation automatique d'infos bulles **/
        MyGrid.enableTooltips("false");

        /** Chargement au format XML **/
        MyGrid.loadXML("{{path('suivi_cron_vue_generale_xml')}}",function(){
            /** on regroupe par rapport à la premiére colonne(CRON) et on cache cette derniére **/
            {#MyGrid.customGroupFormat=function(count){
                return "this is my ::: " + count
            };#}
            MyGrid.groupBy(0,["","#title","#cspan","#cspan","#cspan","#cspan","#cspan","#cspan"]);
            MyGrid.setColumnHidden(0,true);
        });
        
        function reloadGrid() {
            MyGrid.updateFromXML("{{path('suivi_cron_vue_generale_xml')}}",true,true,function(){
                MyGrid.groupBy(0,["","#title","#cspan","#cspan","#cspan","#cspan","#cspan","#cspan"]);
                MyGrid.setColumnHidden(0,true);
            });
        }
        //Mise en place d'un timer pour le rafraichissement automatique
{#        MyGrid.updateFromXML("{{path('suivi_cron_vue_generale_xml')}}",true,true).delay(15000);#}
    </script>
{% endblock %}