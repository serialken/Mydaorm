<?php

namespace Ams\ExploitationBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Doctrine\DBAL\DBALException;

/**
 * Class SuiviCommandRepository
 * 
 * @package Ams\ExploitationBundle\Repository
 */
class SuiviCommandRepository extends EntityRepository
{
    public $tableNameCmd = "suivi_de_command";
    public $tableNameCron = "suivi_de_cron";
    
    /**
     * 
     * @return type
     */
    public function getLibelleCommand(){
        $sql = "SELECT DISTINCT libelle_command FROM ".$this->tableNameCmd."  WHERE libelle_command NOT IN ('end_sh', 'init_sh')";
        return $this->_em->getConnection()->fetchAll($sql);
    }
    
    /**
     * 
     * @param type $date
     * @param type $heure
     * @param type $name
     * @param type $etat
     * @return type
     */
    public function getListSuiviCommand($date,$heure, $name, $etat){
        $sql = "SELECT 
            co.id, 
            co.libelle_command,
            co.heure_debut,
            co.heure_fin,
            co.etat,
            cr.etat as etat_cron,
            co.message,
            co.error_type,
            co.log_file,
            co.id_cron,
            co.libelle_cron 
            FROM ".$this->tableNameCmd." co INNER JOIN  ".$this->tableNameCron."  cr ON co.id_cron = cr.id  "
                . "WHERE co.libelle_command NOT IN ('end_sh', 'init_sh')";
        $sql .= " AND co.heure_debut >= '".$date." ". $heure[0]."' AND co.heure_debut <= '".$date." ".$heure[1]."' ";
        if ($name != "all"){
            $sql .= " AND co.libelle_command like '%".$name."%'  ";
        }
        if ($etat != "all"){
            $sql .= " AND co.etat like '%".$etat."%'  ";
        }
        return $this->_em->getConnection()->fetchAll($sql);
    }
    
    /**
     * 
     * @param type $id
     * @return type
     */
    public function getLogPathById($id){
        $sql = "SELECT log_file FROM ".$this->tableNameCmd."   WHERE id = ".$id."  ";
        return $this->_em->getConnection()->fetchAll($sql);
    }
    
    /**
     * 
     * @param type $id
     * @return type
     */
    public function getEtatByIdCron($id){
        $sql = "SELECT etat FROM ".$this->tableNameCmd."   WHERE id = ".$id."  ";
        return $this->_em->getConnection()->fetchAll($sql);
    }
}
